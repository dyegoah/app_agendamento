<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel do Desenvolvedor - Sistema 8.0</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body{background:linear-gradient(180deg,#f8f9fa,#e9ecef);font-family:'Poppins',sans-serif;padding:15px}
    h2{font-weight:700;color:#007bff}
    .card{border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,.1);border:1px solid #dee2e6}
    .table{font-size:.8rem;margin-bottom:0}
    .table thead{background:linear-gradient(90deg,#6c757d,#adb5bd);color:#fff}
    .table td,.table th{text-align:center;border:1px solid #dee2e6;white-space:nowrap;vertical-align:middle!important}
    .alerta{position:fixed;top:20px;right:20px;z-index:9999;display:none}
    .senha-campo{display:flex;align-items:center;justify-content:center}
    .senha-campo input{width:90px;text-align:center}
    .senha-campo button{border:none;background:none;padding:0 5px;cursor:pointer}
  </style>
</head>
<body>

  <script>
    // ✅ Bloqueio server-side + client-side: se a sessão cair, volta pro login
    (async function enforce(){
      try{
        const r=await fetch(`/api/dev-session`,{credentials:"include"});
        if(!r.ok){ window.location.replace("/dev/login"); }
      }catch(e){ window.location.replace("/dev/login"); }
    })();
  </script>

  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2><i class="bi bi-tools"></i> Painel do Desenvolvedor</h2>
      <a id="btnSair" href="/logout-dev" class="btn btn-outline-danger btn-sm">
        <i class="bi bi-box-arrow-right"></i> Sair
      </a>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div><h6 class="text-secondary fw-semibold mb-0">Gerenciamento de Lojas e Clientes</h6></div>
      <div>
        <a id="linkCadastroLojas" href="/cadastroLojas.html" class="btn btn-success btn-sm me-2" onclick="alerta('Iniciando cadastro de nova loja')">
          <i class="bi bi-person-plus"></i> Nova Loja
        </a>
        <button class="btn btn-primary btn-sm" onclick="exportarCSV()">
          <i class="bi bi-download"></i> Exportar Relatório
        </button>
      </div>
    </div>

    <div class="card p-3">
      <div class="table-responsive">
        <table class="table table-bordered table-sm table-hover">
          <thead>
          <tr>
            <th>#</th><th>Comprador</th><th>Loja</th><th>E-mail</th><th>Telefone</th>
            <th>Cidade</th><th>Estado</th><th>Data</th><th>Status</th><th>Senha</th><th>Ações</th>
          </tr>
          </thead>
          <tbody id="tabelaLojas"></tbody>
        </table>
      </div>
    </div>

    <div id="alertaMsg" class="alert alert-success alerta"></div>

    <div class="text-center mt-3">
      <p class="text-muted small mb-0">© 2025 - Sistema 8.0 | Painel do Desenvolvedor</p>
    </div>
  </div>

 
  <script>
  (async function enforceSession(){
    try{
      const r=await fetch(`/api/dev-session`,{credentials:"include"});
      if(!r.ok) window.location.replace("/dev/login");
    }catch{ window.location.replace("/dev/login"); }
  })();
  </script>

  
   <script>
    let lojas=[]; const tabela=document.getElementById("tabelaLojas");

    async function carregarLojas(){
      try{
        const resp=await fetch(`/api/lojas`,{credentials:"include"});
        if(!resp.ok) throw new Error("Erro ao buscar lojas");
        lojas=await resp.json();
        renderizar();
      }catch(e){
        console.error("Erro ao carregar lojas:",e);
        alerta("Erro ao carregar lojas do banco.","danger");
      }
    }
    function alerta(mensagem,tipo="success"){
      const el=document.getElementById("alertaMsg");
      el.className=`alert alert-${tipo} alerta`; el.textContent=mensagem; el.style.display="block";
      setTimeout(()=>el.style.display="none",2200);
    }
    function renderizar(){
      tabela.innerHTML="";
      if(lojas.length===0){
        tabela.innerHTML=`<tr><td colspan="11" class="text-muted text-center">Nenhuma loja cadastrada.</td></tr>`;
        return;
      }
      lojas.forEach((l,i)=>{
        tabela.innerHTML+=`
        <tr>
          <td>${i+1}</td>
          <td>${l.nomeComprador}</td>
          <td>${l.nomeLoja}</td>
          <td>${l.email}</td>
          <td>${l.telefone||"-"}</td>
          <td>${l.cidade||"-"}</td>
          <td>${l.estado||"-"}</td>
          <td>${l.dataCompra||"-"}</td>
          <td><span class="${l.status==='EM_DIA'?'text-success':'text-danger'} fw-bold">${l.status}</span></td>
          <td class="senha-campo">
            <input type="password" id="senha-${i}" class="form-control form-control-sm" value="${l.senha||''}" onchange="atualizarSenha(${i})">
            <button onclick="toggleSenha(${i})" title="Mostrar/Ocultar senha"><i class="bi bi-eye"></i></button>
          </td>
          <td>
            <button class="btn btn-sm btn-outline-warning" onclick="alternar(${i})" title="Alterar status"><i class="bi bi-arrow-repeat"></i></button>
            <button class="btn btn-sm btn-outline-danger" onclick="remover(${i})" title="Excluir loja"><i class="bi bi-trash"></i></button>
          </td>
        </tr>`;
      });
    }
    async function alternar(i){
      const nova=lojas[i].status==="EM_DIA"?"INADIMPLENTE":"EM_DIA";
      if(!confirm(`Deseja alterar o status da loja "${lojas[i].nomeLoja}" para ${nova}?`))return;
      try{
        await fetch(`/api/lojas/${lojas[i].id}/status`,{
          method:"PUT", headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({status:nova})
        });
        alerta(`Status da loja "${lojas[i].nomeLoja}" alterado para "${nova}"`);
        carregarLojas();
      }catch{ alerta("Erro ao atualizar status.","danger"); }
    }
    async function atualizarSenha(i){
      const novaSenha=document.getElementById(`senha-${i}`).value.trim();
      if(!novaSenha) return;
      try{
        await fetch(`/api/lojas/${lojas[i].id}/senha`,{
          method:"PUT", headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({senha:novaSenha})
        });
        alerta(`Senha da loja "${lojas[i].nomeLoja}" atualizada.`);
      }catch{ alerta("Erro ao atualizar senha.","danger"); }
    }
    function toggleSenha(i){
      const campo=document.getElementById(`senha-${i}`);
      const icone=campo.nextElementSibling.querySelector("i");
      if(campo.type==="password"){campo.type="text";icone.classList.replace("bi-eye","bi-eye-slash")}
      else{campo.type="password";icone.classList.replace("bi-eye-slash","bi-eye")}
    }
    async function remover(i){
      const lojaNome=lojas[i].nomeLoja;
      if(!confirm(`Deseja realmente excluir a loja "${lojaNome}"?`)) return;
      try{
        await fetch(`/api/lojas/${lojas[i].id}`,{method:"DELETE"});
        alerta(`Loja "${lojaNome}" removida com sucesso.`,"danger");
        carregarLojas();
      }catch{ alerta("Erro ao excluir loja.","danger"); }
    }
    function exportarCSV(){
      if(lojas.length===0){ alerta("Nenhum dado disponível para exportação","warning"); return; }
      let csv="data:text/csv;charset=utf-8,";
      csv+="Comprador;Loja;Email;Telefone;Cidade;Estado;Data;Status\n";
      lojas.forEach(l=>{
        csv+=`${l.nomeComprador};${l.nomeLoja};${l.email};${l.telefone||""};${l.cidade||""};${l.estado||""};${l.dataCompra||""};${l.status}\n`;
      });
      const link=document.createElement("a");
      link.setAttribute("href",encodeURI(csv));
      link.setAttribute("download","relatorio_lojas.csv");
      document.body.appendChild(link); link.click();
      alerta("Relatório exportado com sucesso!");
    }
    carregarLojas();
  </script>

  
  
</body>
</html>
