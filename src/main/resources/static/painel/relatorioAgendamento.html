<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <title>Relat√≥rio de Agendamento</title>
  
  <link rel="stylesheet" href="/painel/topbar.css">
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body { background-color: #f8f9fa; }
    .card { border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 1.2rem; }
    .card-header { background-color: #6c757d; color: white; font-weight: 600; }
    .counter { font-size: 1.8rem; font-weight: bold; }
    .label { font-size: 0.9rem; color: #555; }
	
	body {
	  background-color: #f8f9fa;
	  padding-bottom: 80px; /* üîπ espa√ßo para evitar corte no final da tela */
	}

	/* üåô MODO ESCURO PREMIUM - RELATORIOAGENDAMENTO */
	body.dark-mode {
	  background-color: #0f1117;
	  color: #e4e6eb;
	  padding-bottom: 80px;
	}

	/* Topbar moderno no dark */
	body.dark-mode .topbar-modern {
	  background: linear-gradient(135deg, #1a1d29, #2d1b69);
	  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
	  border-bottom: 1px solid rgba(255,255,255,0.1);
	}

	/* Cards com gradiente sutil e bordas */
	body.dark-mode .card {
	  background: linear-gradient(145deg, #1a1d29, #161922) !important;
	  border: 1px solid rgba(255,255,255,0.08);
	  box-shadow: 0 8px 25px rgba(0,0,0,0.25);
	  color: #e4e6eb;
	  border-radius: 12px;
	}

	body.dark-mode .card:hover {
	  transform: translateY(-2px);
	  box-shadow: 0 12px 30px rgba(0,0,0,0.35);
	}

	/* Cabe√ßalhos dos cards */
	body.dark-mode .card-header {
	  background: linear-gradient(135deg, #1f2230, #252837) !important;
	  border-bottom: 1px solid rgba(255,255,255,0.1);
	  color: #e4e6eb !important;
	  font-weight: 600;
	}

	/* Cores espec√≠ficas dos cabe√ßalhos */
	body.dark-mode .card-header.bg-primary {
	  background: linear-gradient(135deg, #6366f1, #8b5cf6) !important;
	}

	body.dark-mode .card-header.bg-danger {
	  background: linear-gradient(135deg, #ef4444, #dc2626) !important;
	}

	body.dark-mode .card-header.bg-success {
	  background: linear-gradient(135deg, #10b981, #059669) !important;
	}

	body.dark-mode .card-header.bg-warning {
	  background: linear-gradient(135deg, #f59e0b, #d97706) !important;
	  color: #ffffff !important;
	}

	body.dark-mode .card-header.bg-secondary {
	  background: linear-gradient(135deg, #6b7280, #4b5563) !important;
	}

	body.dark-mode .card-header.bg-info {
	  background: linear-gradient(135deg, #0ea5e9, #0284c7) !important;
	}

	body.dark-mode .card-header.bg-dark {
	  background: linear-gradient(135deg, #1f2230, #252837) !important;
	}

	/* Contadores e textos */
	body.dark-mode .counter {
	  font-size: 1.8rem;
	  font-weight: bold;
	  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
	}

	body.dark-mode .label {
	  font-size: 0.9rem;
	  color: #9ca3af !important;
	}

	/* Cores dos contadores */
	body.dark-mode .text-primary {
	  color: #6366f1 !important;
	}

	body.dark-mode .text-danger {
	  color: #ef4444 !important;
	}

	body.dark-mode .text-success {
	  color: #10b981 !important;
	}

	body.dark-mode .text-dark {
	  color: #e4e6eb !important;
	}

	body.dark-mode .text-secondary {
	  color: #9ca3af !important;
	}

	/* Bordas dos cards */
	body.dark-mode .border-primary {
	  border-color: #6366f1 !important;
	}

	body.dark-mode .border-danger {
	  border-color: #ef4444 !important;
	}

	body.dark-mode .border-success {
	  border-color: #10b981 !important;
	}

	body.dark-mode .border-warning {
	  border-color: #f59e0b !important;
	}

	body.dark-mode .border-secondary {
	  border-color: #6b7280 !important;
	}

	/* Tabela de resumo */
	body.dark-mode .table {
	  background: #1a1d29 !important;
	  color: #e4e6eb;
	  border: 1px solid rgba(255,255,255,0.08);
	}

	body.dark-mode .table-dark {
	  background: linear-gradient(135deg, #1f2230, #252837) !important;
	  color: #ffffff;
	}

	body.dark-mode .table-dark th {
	  background: transparent !important;
	  border-color: rgba(255,255,255,0.1);
	  color: #ffffff;
	  font-weight: 600;
	}

	body.dark-mode .table-striped tbody tr:nth-child(odd) {
	  background-color: rgba(255,255,255,0.02);
	}

	body.dark-mode .table-striped tbody tr:nth-child(even) {
	  background-color: rgba(255,255,255,0.05);
	}

	body.dark-mode .table-bordered {
	  border: 1px solid rgba(255,255,255,0.1);
	}

	body.dark-mode .table-bordered th,
	body.dark-mode .table-bordered td {
	  border: 1px solid rgba(255,255,255,0.1);
	}

	body.dark-mode .table tbody tr:hover {
	  background: linear-gradient(90deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1)) !important;
	  color: #ffffff;
	}

	/* Gr√°fico Chart.js */
	body.dark-mode .card-body canvas {
	  background: rgba(255,255,255,0.02);
	  border-radius: 8px;
	  padding: 10px;
	}

	/* Textos do cabe√ßalho */
	body.dark-mode h4.fw-bold.text-secondary {
	  color: #a5b4fc !important;
	  text-shadow: 0 2px 4px rgba(0,0,0,0.3);
	}

	/* Efeitos de hover nos √≠cones da topbar */
	body.dark-mode .topbar-modern .nav-item:hover i {
	  animation: pulse 0.5s ease;
	  color: #a5b4fc;
	  text-shadow: 0 0 8px rgba(165, 180, 252, 0.6),
	               0 0 12px rgba(99, 102, 241, 0.5);
	}

	body.dark-mode .topbar-modern .theme-toggle:hover i {
	  animation: pulse 0.5s ease;
	  color: #a5b4fc;
	  text-shadow: 0 0 8px rgba(165, 180, 252, 0.6),
	               0 0 12px rgba(99, 102, 241, 0.6);
	}

	body.dark-mode .topbar-modern .user-menu:hover .user-avatar i {
	  animation: pulse 0.5s ease;
	  color: #a5b4fc;
	  text-shadow: 0 0 10px rgba(165, 180, 252, 0.6),
	               0 0 14px rgba(99, 102, 241, 0.5);
	}

	/* Anima√ß√µes */
	@keyframes pulse {
	  0% { transform: scale(1); filter: brightness(1); }
	  50% { transform: scale(1.2); filter: brightness(1.5); }
	  100% { transform: scale(1); filter: brightness(1); }
	}

	/* Responsividade */
	@media (max-width: 768px) {
	  body.dark-mode .counter {
	    font-size: 1.5rem;
	  }
	  
	  body.dark-mode .card-body {
	    padding: 1rem;
	  }
	}

	/* Scrollbar personalizada */
	body.dark-mode ::-webkit-scrollbar {
	  width: 8px;
	}

	body.dark-mode ::-webkit-scrollbar-track {
	  background: #1a1d29;
	}

	body.dark-mode ::-webkit-scrollbar-thumb {
	  background: rgba(99, 102, 241, 0.5);
	  border-radius: 4px;
	}

	body.dark-mode ::-webkit-scrollbar-thumb:hover {
	  background: rgba(99, 102, 241, 0.7);
	}

	/* Estilo para o gr√°fico no modo escuro */
	body.dark-mode .chartjs-render-monitor {
	  filter: brightness(0.9) contrast(1.1);
	}

	/* Melhorias de legibilidade */
	body.dark-mode .text-muted {
	  color: #8a8fa8 !important;
	}

	body.dark-mode .table .text-center {
	  color: #e4e6eb !important;
	}

	/* Destaque para valores importantes */
	body.dark-mode .counter.text-success {
	  color: #10b981 !important;
	  text-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
	}

	body.dark-mode .counter.text-danger {
	  color: #ef4444 !important;
	  text-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
	}

	body.dark-mode .counter.text-primary {
	  color: #6366f1 !important;
	  text-shadow: 0 2px 8px rgba(99, 102, 241, 0.3);
	}

	/* Efeito de brilho suave nos cards */
	body.dark-mode .card::before {
	  content: '';
	  position: absolute;
	  top: 0;
	  left: 0;
	  right: 0;
	  height: 1px;
	  background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.3), transparent);
	}

	/* Transi√ß√µes suaves */
	body.dark-mode .card,
	body.dark-mode .table,
	body.dark-mode .counter {
	  transition: all 0.3s ease;
	}
	
  </style>
</head>

<body>
	<!-- ====== RELAT√ìRIO GERAL DO SISTEMA ====== -->
	<div class="container-fluid mt-5">
	 
		<header class="topbar-modern">
			  <div class="logo-section">
			    <img id="logoCliente" 
			         src="/imagens/logo%20Jamille.png"
			         alt="Logo Jamille Higino"
			         class="logo"
			         onerror="this.onerror=null; this.src='/imagens/logo-padrao.png';">
			    <div class="brand-info">
			      <div class="brand-name">Jamille Higino</div>
			      <div class="brand-subtitle">Enfermagem e Est√©tica</div>
			    </div>
			  </div>

			  <nav class="nav-section">
			    <a href="/painel/painelGerencia.html" class="nav-item"><i class="bi bi-house-door"></i><span>Home</span></a>
			    <a href="/painel/agendamentoServico.html" class="nav-item"><i class="bi bi-calendar-check"></i><span>Agendamento</span></a>
			    <a href="/painel/configAgendamento.html" class="nav-item"><i class="bi bi-gear"></i><span>Configura√ß√£o</span></a>
			    <a href="/painel/relatorioAgendamento.html" class="nav-item"><i class="bi bi-bar-chart"></i><span>Relat√≥rios</span></a>
			    <a href="/painel/agendamentoDespesa.html" class="nav-item"><i class="bi bi-cash-coin"></i><span>Despesas</span></a>
			  </nav>

			  <div class="user-section">
			    <button id="btnModo" class="theme-toggle"><i class="bi bi-moon-stars"></i></button>
			    <div class="user-menu" id="userMenuDropdown">
			      <div class="user-avatar"><i class="bi bi-person"></i></div>
			      <span>Admin</span>
			    </div>
			  </div>
			</header>
		
		
		 <h4 class="fw-bold text-secondary mb-3"><i class="bi bi-graph-up"></i> Relat√≥rio Geral do Sistema</h4>

	  <!-- ====== INDICADORES FINANCEIROS ====== -->
	  <div class="row g-3">
	    <div class="col-md-4">
	      <div class="card border-primary">
	        <div class="card-header bg-primary text-white"><i class="bi bi-wallet2"></i> Receitas Totais</div>
	        <div class="card-body text-center">
	          <div id="valorReceitas" class="counter text-primary">R$ 0,00</div>
	          <div class="label">Soma dos agendamentos atendidos</div>
	        </div>
	      </div>
	    </div>
	    <div class="col-md-4">
	      <div class="card border-danger">
	        <div class="card-header bg-danger text-white"><i class="bi bi-cart-x"></i> Despesas Totais</div>
	        <div class="card-body text-center">
	          <div id="valorDespesas" class="counter text-danger">R$ 0,00</div>
	          <div class="label">Soma de despesas registradas</div>
	        </div>
	      </div>
	    </div>
	    <div class="col-md-4">
	      <div class="card border-success">
	        <div class="card-header bg-success text-white"><i class="bi bi-coin"></i> Lucro L√≠quido</div>
	        <div class="card-body text-center">
	          <div id="valorLucro" class="counter text-success">R$ 0,00</div>
	          <div class="label">Receitas - Despesas</div>
	        </div>
	      </div>
	    </div>
	  </div>

	  <!-- ====== PRODUTOS E MATERIAIS ====== -->
	  <div class="row g-3 mt-3">
	    <div class="col-md-6">
	      <div class="card border-warning">
	        <div class="card-header bg-warning text-dark"><i class="bi bi-box-seam"></i> Produtos e Materiais</div>
	        <div class="card-body text-center">
	          <div id="qtdProdutos" class="counter text-dark">0</div>
	          <div class="label">Quantidade de itens cadastrados</div>
	        </div>
	      </div>
	    </div>
	    <div class="col-md-6">
	      <div class="card border-secondary">
	        <div class="card-header bg-secondary text-white"><i class="bi bi-exclamation-triangle"></i> Produtos Vencidos</div>
	        <div class="card-body text-center">
	          <div id="qtdVencidos" class="counter text-secondary">0</div>
	          <div class="label">Itens fora da validade</div>
	        </div>
	      </div>
	    </div>
	  </div>

	  <!-- ====== RANKING DE SERVI√áOS ====== -->
	  <div class="card mt-4">
	    <div class="card-header bg-info text-white"><i class="bi bi-bar-chart-line"></i> Ranking de Procedimentos</div>
	    <div class="card-body">
	      <canvas id="graficoServicosRank"></canvas>
	    </div>
	  </div>

	  <!-- ====== RESUMO FINAL ====== -->
	  <div class="card mt-4">
	    <div class="card-header bg-dark text-white"><i class="bi bi-table"></i> Resumo Consolidado</div>
	    <div class="card-body">
	      <table class="table table-striped table-bordered align-middle text-center">
	        <thead class="table-dark">
	          <tr>
	            <th>Indicador</th>
	            <th>Quantidade</th>
	            <th>Valor (R$)</th>
	            <th>Observa√ß√£o</th>
	          </tr>
	        </thead>
	        <tbody id="tabelaResumo"></tbody>
	      </table>
	    </div>
	  </div>
	</div>

	<script>
	async function carregarRelatorioGeral() {
	  try {
	    const respDespesas = await fetch("/api/agendamento-despesa");
	    const despesas = await respDespesas.json();

	    // ====== C√ÅLCULOS ======
	    const atendidos = agendamentos.filter(a => a.status === "Atendido");
	    const receitas = atendidos.reduce((acc, a) => {
	      const servico = servicosCadastrados.find(s => s.item === a.servico || s.nome === a.servico);
	      return acc + (servico ? parseFloat(servico.valor || servico.valorUnitario || 0) : 0);
	    }, 0);

	    const totalDespesas = despesas.reduce((acc, d) => acc + (parseFloat(d.valorTotal) || 0), 0);
	    const lucro = receitas - totalDespesas;

	    document.getElementById("valorReceitas").textContent = `R$ ${receitas.toFixed(2).replace('.', ',')}`;
	    document.getElementById("valorDespesas").textContent = `R$ ${totalDespesas.toFixed(2).replace('.', ',')}`;
	    document.getElementById("valorLucro").textContent = `R$ ${lucro.toFixed(2).replace('.', ',')}`;

	    // ====== PRODUTOS E VENCIDOS ======
	    const hoje = new Date();
	    const vencidos = despesas.filter(d => new Date(d.dataVencimento) < hoje);
	    document.getElementById("qtdProdutos").textContent = despesas.length;
	    document.getElementById("qtdVencidos").textContent = vencidos.length;

	    // ====== RANKING DE SERVI√áOS ======
	    const contagemServicos = {};
	    agendamentos.forEach(a => {
	      if (!a.servico) return;
	      contagemServicos[a.servico] = (contagemServicos[a.servico] || 0) + 1;
	    });

	    const servicosOrdenados = Object.entries(contagemServicos).sort((a,b)=>b[1]-a[1]);
	    const labels = servicosOrdenados.map(s=>s[0]);
	    const valores = servicosOrdenados.map(s=>s[1]);

	    new Chart(document.getElementById("graficoServicosRank"), {
	      type: "pie",
	      data: {
	        labels: labels,
	        datasets: [{
	          data: valores,
	          backgroundColor: ["#198754","#0d6efd","#dc3545","#ffc107","#6610f2","#20c997","#fd7e14"]
	        }]
	      },
	      options: { plugins: { legend: { position: "right" } } }
	    });

	    // ====== RESUMO FINAL ======
	    const resumo = [
	      { nome: "Agendamentos Totais", qtd: agendamentos.length, valor: "-", obs: "Inclui todos os status" },
	      { nome: "Agendamentos Atendidos", qtd: atendidos.length, valor: receitas.toFixed(2), obs: "Somente atendidos" },
	      { nome: "Agendamentos Cancelados", qtd: agendamentos.filter(a=>a.status==='Cancelado').length, valor: "-", obs: "Cancelados" },
	      { nome: "Despesas Totais", qtd: despesas.length, valor: totalDespesas.toFixed(2), obs: "Todos os lan√ßamentos" },
	      { nome: "Produtos Vencidos", qtd: vencidos.length, valor: "-", obs: "Itens fora da validade" },
	      { nome: "Lucro L√≠quido", qtd: "-", valor: lucro.toFixed(2), obs: "Receitas - Despesas" },
	    ];

	    const tbody = document.getElementById("tabelaResumo");
	    tbody.innerHTML = resumo.map(r=>`
	      <tr>
	        <td>${r.nome}</td>
	        <td>${r.qtd}</td>
	        <td>${r.valor !== "-" ? "R$ " + r.valor.replace('.', ',') : "-"}</td>
	        <td>${r.obs}</td>
	      </tr>`).join("");

	  } catch (erro) {
	    console.error("Erro ao carregar relat√≥rio geral:", erro);
	  }
	}

	// üîπ Executa ap√≥s o relat√≥rio de agendamentos principal
	document.addEventListener("DOMContentLoaded", () => {
	  setTimeout(carregarRelatorioGeral, 1500);
	});
	</script>

	<script src="/painel/topbar.js"></script>    
</body>
</html>
